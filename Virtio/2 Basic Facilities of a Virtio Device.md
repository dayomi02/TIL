# Basic Facilities of a Virtio Device

가상 디바이스는 버스별 방법으로 검색되고 식별됩니다. 각 장치는 다음 부품으로 구성됩니다.

- Device status field
- Feature bits
- Notifications
- Device Configuration space
- One or more virtqueues

## 1. Device Status Field

드라이버에 의한 장치 초기화 중에 드라이버는 3.1에 명시된 단계 순서를 따릅니다. (장치 초기화)

장치 상태 필드는 이 시퀀스의 완료된 단계에 대한 간단한 하위 수준 표시를 제공합니다. 각 장치의 상태를 나타내는 콘솔의 신호등에 연결된 것을 상상하는 것이 가장 유용합니다. 다음 비트가 정의됩니다(일반적으로 설정되는 순서대로 아래 나열됨).

**ACKNOWLEDGE** (1) 
게스트 OS가 디바이스를 찾아 유효한 가상 디바이스로 인식했음을 나타냅니다.

**DRIVER** (2)
게스트 OS가 디바이스 구동 방법을 알고 있음을 나타냅니다. 참고: 이 비트를 설정하기 전에 상당한 지연(또는 무한)이 발생할 수 있습니다.

**FAILED** (128) 
게스트에서 문제가 발생하여 디바이스를 포기했음을 나타냅니다. 이것은 내부 오류일 수도 있고, 어떤 이유로든 드라이버가 장치를 좋아하지 않거나 장치 작동 중에 치명적인 오류가 발생할 수도 있습니다.

**FEATURES_OK** (8)
운전자가 자신이 이해하고 있는 모든 기능을 승인했으며 기능 협상이 완료되었음을 나타냅니다.

**DRIVER_OK** (4)
드라이버가 설정되어 있고 장치를 구동할 준비가 되었음을 나타냅니다.

**DEVICE_NEEDS_RESET** (64)
장치에 복구할 수 없는 오류가 발생했음을 나타냅니다.

### Requirements

요구 사항

드라이버는 장치 상태를 업데이트해야 하며 3.1에 지정된 드라이버 초기화 시퀀스의 완료된 단계를 나타내도록 비트를 설정해야 합니다. 운전자는 장치 상태 비트를 삭제해서는 안 됩니다. 드라이버가 실패 비트를 설정한 경우 나중에 다시 초기화하기 전에 먼저 장치를 재설정해야 합니다.

DEVICE_NEEDS_RESET가 설정된 경우 드라이버는 장치의 작업 완료에 의존해서는 안 됩니다.

---

## 2. Feature Bits

각 가상 디바이스는 모든 기능을 제공합니다. 장치 초기화 중에 드라이버는 이 내용을 읽고 장치에 수락하는 부분 집합을 알려줍니다. 재협상을 할 수 있는 유일한 방법은 장치를 재설정하는 것이다. 기능 비트는 다음과 같이 할당됩니다.

0 ~ 23 
특정 장치 유형에 대한 Feature bits

24 ~ 37 
큐 확장에 예약된 Feature bits 및 기능 협상 메커니즘

38 이상 Feature bits
이후 확장을 위해 예약됩니다.

---

## 3. Notification

알림

알림(드라이버를 장치 또는 장치로 드라이버로)을 보내는 개념은 이 규격에서 중요한 역할을 한다. 알림의 모드 피연산자는 전송에 따라 다릅니다.

알림에는 세 가지 유형이 있습니다.

- configuration change notification : 구성 변경 알림
- available buffer notification : 사용 가능한 버퍼 알림
- used buffer notification : 사용된 버퍼 알림

구성 변경 알림 및 사용된 버퍼 알림은 장치에서 전송되고 수신자는 드라이버입니다. 구성 변경 알림은 디바이스 구성 공간이 변경되었음을 나타내고, 사용된 버퍼 알림은 알림에 의해 지정된 가상 큐에서 버퍼가 사용되었을 수 있음을 나타냅니다.

사용 가능한 버퍼 알림은 드라이버에서 전송되며 수신자는 장치입니다. 이 알림 유형은 알림에 의해 지정된 가상 대기열에서 버퍼를 사용할 수 있음을 나타냅니다.

대부분의 전송은 인터럽트를 사용하여 장치에 의해 드라이버로 전송되는 알림을 구현합니다. 따라서 이 규격의 이전 버전에서는 이러한 알림을 인터럽트(interrupt)라고 부르는 경우가 많았다. 이 규격에 정의된 일부 이름은 여전히 이 인터럽트 용어를 유지합니다. 이벤트라는 용어는 통지 또는 통지 수신을 나타내는 데 사용되는 경우가 있습니다.

---

## 4. Device Configuration Space

장치 구성 공간은 일반적으로 거의 변경되지 않거나 초기화 시간 매개 변수에 사용됩니다. 구성 필드는 선택 사항인 경우 다음과 같은 기능 비트로 표시됩니다. 이 규격의 이후 버전은 끝에 추가 필드를 추가하여 장치 구성 공간을 확장할 수 있습니다.

---

## 5. Virtqueues

가상 디바이스에서 대량 데이터 전송을 위한 메커니즘을 가상으로 virtque라고 합니다. 각 디바이스에는 0개 이상의 가상 대기열이 있을 수 있습니다.

드라이버는 사용 가능한 버퍼를 큐에 추가하고, 요청을 설명하는 버퍼를 가상 큐에 추가하고, 선택적으로 드라이버 이벤트를 트리거하여 사용 가능한 버퍼 알림을 장치로 전송하여 요청을 사용할 수 있게 합니다.

장치는 요청을 실행하고 - 완료되면 - 사용된 버퍼를 큐에 추가합니다. 버퍼를 사용된 것으로 표시하여 드라이버에게 알립니다. 그런 다음 장치는 장치 이벤트를 트리거하고 사용된 버퍼 알림을 드라이버로 전송할 수 있습니다.

장치는 사용하는 각 버퍼에 대해 메모리에 쓴 바이트 수를 보고합니다. 이를 "used length"라고 합니다.

일반적으로 버퍼를 드라이버에서 사용할 수 있게 한 순서와 동일한 순서로 사용할 필요는 없습니다.

각 virtque는 최대 3개의 부분으로 구성될 수 있습니다.

- Descriptor 영역 - 버퍼를 설명하는 데 사용
- Driver 영역 - 운전자가 장치에 제공하는 추가 데이터 (Available Ring)
- Device 영역 - 장치에 의해 운전자에게 제공되는 추가 데이터 (Used Ring)
