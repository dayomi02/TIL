## Interrupt

인터럽트는 이름 그대로 프로그램의 흐름을 누군가 가로채는 것을 말한다. ARM에서는 인터럽트와 익셉션이 차이 없이 동작한다. 인터럽프와 익셉션을 의미적으로 구분하면 인터럽트는 외부 요인에 의해서 발생하는 것이다. 행동들이 인터럽트를 발생시킨다. (화면 터치) 사용자의 행동뿐만 아니라 시간의 흐름에 의해서도 인터럽트는 발생한다. (시간을 정해서 그 시간마타 인터럽트 발생) 

<br>

인터럽트는 필연적으로 지연(latency)을 발생시킨다. 인터럽트 지연이란 하드웨어가 인터럽트를 감지해서 ARM에 인터럽트 신호가 입력되는 순간부터 펌웨어에서 인터럽트 핸들러가 수행되기 직전까지 걸리는 시간을 말한다. 즉 프로세스가 중단되고 인터럽트 서비스 루틴이 돌기 직전까지의 시간. 짧은 시간이지만 임베디드 시스템의 목적에 따라서 이 시간이 문제가 되기도 한다. 그렇기 때문에 백터 인터럽트 컨트롤러 (Vectored Interrupt Controller, VIC) 등의 별도 하드웨어로 인터럽트 지연을 최소한으로 줄이려는 여러 가지 시도를 한다.

<br>

ARM은 두 종류의 인터럽트를 제공한다. IRQ와 FIQ이다. FIQ의 F는 Fast이다. 인터럽트가 발생하면 익셉션 처리에 해당하는 동작을 수행하고 IRQ 익셉션 혹은 FIQ 익셉션 백터로 PC가 변경된다. 

<br>

인터럽트에 대한 다섯 가지 개념

- Interrupt Request(IRQ)
- Fast Interrupt Request(FIQ)
- Nob-Maskable Fast Interrupt(NMFI)
- Low Interrupt Latency(LIL)
- Interrupt Controller(IC)

<br>

IRQ는 Interrupt Request의 약자이다. IRQ는 FIQ보다 우선순위가 낮으므로 동시에 발생할 경우 ARM은 FIQ에 대한 처리 요청을 펌웨어에 먼저 보낸다. CPSR의 I비트를 1로 설정하면 IRQ 익셉션을 비활성화 한다. 비활성화하면 자동으로 IRQ에 해당하는 모든 인터럽트 요청도 펌웨어로 처리되지 않는다.

<br>

FIQ는 Fast Interrupt Request의 약자이다. 동작 특성은 IRQ와 동일하다. FIQ 익셉션 동작 모드는 별도로 R8 ~ R12 레지스터를 가지고 있어서 IRQ보다 빠르다. 그렇기 때문에 레지스터를 백업하고 복구하는 시간을 사용하지 않아도 된다. 이것을 컨택스트 스위칭 오버헤드를 줄인다고 표현한다.

<br>

Non-Maskable Fast Interrupt는 줄여서 NMFI라고 쓴다. NMFI를 켜면 FIQ를 비활성화 할 수 없다. NMFI를 켜면 FIQ를 비활성화 할 수 없다. 이름 그대로 FIQ는 마스크할 수 없는 인터럽트라는 의미이다. NMFI를 켜면 하드웨어가 자동으로 CPSR의 F비트를 0으로 클리어한다. NMFI를 켰을때 F비트가 1이 되는 경우는 FIQ 익셉션이 발생했거나 릿셋 익셉션이 발생했을 경우 뿐이다. 이 작업은 펌웨어가 아니라 하드웨어가 자동으로 처리하는 것이다.

<br>

Low Interrupt Latency는 인터럽트 지연을 줄이기 위한 기능 중 하나로 ARM의 기본 설정 기능이다. SCTLR의 21번째 비트인 FI 비트로 동작 여부를 확인할 수 있으며, 항상 1로 설정되어있다. LIL은 인터럽트가 발생했을 때 현재 수행 중인 명령의 실행이 아직 끝나지 않았다 하더라고 실행 중인 명령어를 취소해 버리고 인터럽트를 먼저 처리한다. 인터럽트 처리를 한 뒤 인터럽트가 발생했던 시점에서 한 명령어 뒤로 다시 돌아가도록 해서 처리한다.

<br>

ARM은 메모리 타입을 strongly ordered로 설정할 수 있다. Strongly ordered로 설정된 메모리나 장치는 읽기, 쓰기 동작을 수행한 순서와 횟수를 보장해야 한다. 따라서 메모리 접근을 시작한 이후에는 수행이 끝날 때까지 중간에 실행을 멈출 수 업사. 그리고 AXI로 연결된 주변장치도 이와 동일하게 동작한다. 그래서 인터럽트 지연시간을 최소화하기 위해서는 strongly ordered로 설정된 메모리나 장치 그리고 AXI 인터페이스에 연결된 주변장치에 대해서는 멀티워드(multiword) 로드/스토어(load/store) 명령을 되도록 사용하지 않는 것이 좋다.

<br>

AXI (Advanced eXtensible Interface) 
: 다중 채널 버스로, 읽기/쓰기에 최적화 되어 있는 버스이다.

VIC(Vectored Interrupt Controller)를 포함하는 Interrupt Controller는 인터럽트 처리를 전담하는 일종의 주변장치이다. ARM에서 인터럽트가 발생하면 인터럽트가 발생했다는 것만 알 수 있고 어떤 인터럽트가 어떤 하드웨어에서 발생했는지를 알 수 없다. 이것을 알기 위해서는 Interrupt Controller에 물어봐야 한다.

<br>

Interrupt Controller 기능

- 인터럽트가 발생했을 때 해당 인터럽트의 종류를 레지스터에 기록한다.
- 인터럽트가 발생했을 때 ARM의 IRQ 혹은 FIQ에 맞춰서 인터럽트 신호를 준다.
- 특정 인터럽트를 골라서 마스킹할 수 있다. (마스킹된 인터럽트는 비활성화된다.)
- 여러 인터럽트 간에 우선순위를 설정할 수 있다.

<br>

인터럽트 서비스 루틴은 인터럽트 핸들러의 하위 개념이다. 인터럽트 핸들러에서 인터럽트의 종류를 판별한 다음 해당 인터럽트만 전담으로 처리하는 코드로 이동한다. 여기서 해당 인터럽트만 전담하는 코드가 인터럽트 서비스 루틴이다. 

다음 세 단게를 처리해서 인터럽트 서비스 루틴으로 진입한다.

1. 인터럽트 컨트롤러에서 인터럽트 소스가 어떤 것인지를 판별한다.
(인터럽트 핸들러에서 인터럽트 컨트롤러의 값을 읽는다.)
2. 인터럽트 소스에 따라 실행해야 할 인터럽트 서비스 루틴을 선택한다.
3. 해당 인터럽트 소스를 비활성화하고 인터럽트 서비스 루틴으로 진입한다.
